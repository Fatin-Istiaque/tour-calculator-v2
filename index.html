<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Group Expense & Settlement Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .main-content { padding: 30px; }
        .trip-info { text-align: center; margin-bottom: 25px; padding: 15px; background-color: #e9ecef; border-radius: 8px; }
        .trip-info code { background-color: #d1ecf1; padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .section { margin-bottom: 40px; background: #f8f9fa; border-radius: 10px; padding: 25px; border-left: 4px solid #4facfe; }
        .section h2 { color: #2c3e50; margin-bottom: 20px; font-size: 1.8rem; display: flex; align-items: center; }
        .section h2::before { content: ''; width: 30px; height: 30px; background: linear-gradient(135deg, #4facfe, #00f2fe); border-radius: 50%; margin-right: 15px; flex-shrink: 0; }
        .tab-buttons { display: flex; flex-wrap: wrap; background: #e9ecef; border-radius: 8px; padding: 4px; margin-bottom: 20px; }
        .tab-button { flex: 1; background: transparent; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; text-align: center; min-width: 150px; }
        .tab-button.active { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; box-shadow: 0 2px 8px rgba(79, 172, 254, 0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .expense-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 0.9rem; }
        .form-group input, .form-group select { padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 1rem; transition: all 0.3s ease; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #4facfe; box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }
        .multi-select-container { position: relative; width: 100%; }
        .selected-names { padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; cursor: pointer; background: white; user-select: none; }
        .selected-names::after { content: 'â–¼'; float: right; opacity: 0.5; }
        .checkbox-options { display: none; position: absolute; background: white; border: 1px solid #ddd; border-radius: 8px; width: 100%; max-height: 200px; overflow-y: auto; z-index: 10; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .checkbox-options.visible { display: block; }
        .checkbox-options label { display: block; padding: 10px 15px; cursor: pointer; transition: background-color 0.2s; }
        .checkbox-options label:hover { background-color: #f0f8ff; }
        .checkbox-options input { margin-right: 10px; }
        .btn { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4); }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        .btn-success { background: linear-gradient(135deg, #00b894 0%, #00cec9 100%); }
        .btn-success:hover { box-shadow: 0 5px 15px rgba(0, 184, 148, 0.4); }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); }
        .btn-danger:hover { box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4); }
        .table-container { overflow-x: auto; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; min-width: 600px; }
        th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 10px; text-align: left; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 12px 10px; border-bottom: 1px solid #e1e8ed; font-size: 0.9rem; vertical-align: middle; }
        td[contenteditable="true"]:not(.share-cell) { background-color: #f0f8ff; cursor: cell; }
        td[contenteditable="true"]:focus { outline: 2px solid #4facfe; background-color: white; }
        tr.main-row { cursor: pointer; transition: background-color 0.2s; }
        tr.main-row:hover { background: rgba(79, 172, 254, 0.05); }
        tr.main-row.discrepancy-row { background-color: #f8d7da !important; color: #721c24; }
        .expand-icon { display: inline-block; transition: transform 0.3s; margin-right: 8px; }
        tr.main-row.expanded .expand-icon { transform: rotate(90deg); }
        .details-row td { background-color: #f8f9fa; padding: 0; }
        .details-content { padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .share-item { display: flex; flex-direction: column; }
        .share-item label { font-size: 0.8rem; color: #6c757d; margin-bottom: 5px; }
        .share-cell { font-weight: 600; padding: 8px; border: 1px dashed #ced4da; border-radius: 5px; background-color: white; }
        .share-cell:focus { outline: 2px solid #4facfe; }
        .status-ok { color: #155724; font-weight: bold; }
        .status-warning { color: #721c24; font-weight: bold; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s ease; }
        .summary-card:hover { transform: translateY(-5px); }
        .summary-card h3 { color: #2c3e50; margin-bottom: 15px; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }
        .summary-value { font-size: 1.25rem; font-weight: 600; margin: 8px 0; }
        .balance-positive { color: #28a745; }
        .balance-negative { color: #dc3545; }
        .delete-btn { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s ease; }
        .delete-btn:hover { background: #c82333; transform: scale(1.05); }
        .participants-info { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .participants-list { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px; }
        .participant-tag { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; font-weight: 500; backdrop-filter: blur(10px); }
        .action-required { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
        .awaiting-payment { background: #f8d7da; color: #721c24; }
        .should-receive { background: #d4edda; color: #155724; }
        .settled { background: #d1ecf1; color: #0c5460; }
        .payment-preview-container { background: #e9ecef; padding: 15px; border-radius: 8px; font-weight: 500; text-align: center; transition: all 0.3s ease; min-height: 50px; margin-top: 20px; line-height: 1.6; }
        .matrix-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; text-align: center; }
        .matrix-table th, .matrix-table td { border: 1px solid #ddd; padding: 10px; }
        .matrix-table th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .matrix-table td.header-cell { background: #f8f9fa; font-weight: bold; text-align: left; }
        .matrix-table td.diagonal-cell { background-color: #e9ecef; }
        .matrix-table td.no-payment-cell { background-color: #f8f9fa; color: #ccc; }
        .matrix-table td.payment-due-cell { background-color: #d4edda; color: #155724; font-weight: bold; cursor: help; position: relative; }
        .matrix-table td.payment-due-cell:hover::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 5px 10px; border-radius: 5px; white-space: nowrap; z-index: 10; font-size: 0.8rem; }
        .gemini-result-box { margin-top: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-height: 100px; white-space: pre-wrap; line-height: 1.6; border: 1px solid #e1e8ed; position: relative;}
        .copy-btn { position: absolute; top: 10px; right: 10px; background: #e9ecef; border: 1px solid #ced4da; color: #495057; padding: 5px 10px; border-radius: 5px; cursor: pointer; transition: background 0.2s; }
        .copy-btn:hover { background: #d1d5db; }
        .loader { text-align: center; padding: 20px; }
        .loader::after { content: 'âœ¨ Generating...'; color: #6c757d; font-weight: bold; }
        .btn-secondary { background: linear-gradient(135deg, #6c757d, #343a40); }
        .btn-secondary:hover { box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4); }
        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .expense-form, .summary-grid { grid-template-columns: 1fr; }
            .tab-buttons { flex-direction: column; }
            th, td { padding: 8px 6px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ’° Collaborative Expense Tracker</h1>
            <p>Real-time expense tracking and settlement for your group</p>
        </div>
        
        <div class="main-content">
            <div class="trip-info">
                <p>Share this link with your group! Trip ID: <code id="tripId" title="Click to copy">Loading...</code></p>
                 <span id="copyFeedback" style="display:none; color: green; font-weight: bold;">Copied!</span>
            </div>

            <div class="participants-info">
                <h3>ðŸ‘¥ Trip Participants</h3>
                <div class="participants-list">
                    <div class="participant-tag">Nafi</div><div class="participant-tag">Himika</div><div class="participant-tag">Mysha</div><div class="participant-tag">Rafid</div><div class="participant-tag">Razon</div><div class="participant-tag">Naima</div><div class="participant-tag">Zohra</div><div class="participant-tag">Fatin</div>
                </div>
            </div>

            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('add_transaction')">âž• Add Transaction</button>
                    <button class="tab-button" onclick="switchTab('expense_log')">ðŸ§¾ Expense Log</button>
                    <button class="tab-button" onclick="switchTab('payment_log')">ðŸ’¸ Payment Log</button>
                    <button class="tab-button" onclick="switchTab('individual_dashboard')">ðŸ‘¤ Individual Dashboard</button>
                    <button class="tab-button" onclick="switchTab('settlement_matrix')">ðŸ”„ Settlement Matrix</button>
                    <button class="tab-button" onclick="switchTab('insights')">âœ¨ Trip Insights</button>
                     <button class="tab-button" onclick="switchTab('data_management')">ðŸ’¾ Data Management</button>
                </div>

                <div id="add_transaction" class="tab-content active">
                    <div class="section">
                        <h2>ðŸ“Š Add New Expense</h2>
                        <div class="expense-form">
                            <div class="form-group"><label for="expenseDate">Date</label><input type="date" id="expenseDate" required></div>
                            <div class="form-group"><label for="expenseDescription">Description</label><input type="text" id="expenseDescription" placeholder="e.g., Beach Hotel" required></div>
                            <div class="form-group"><label for="expenseAmount">Total Amount (BDT)</label><input type="number" id="expenseAmount" placeholder="0" step="0.01" required></div>
                            <div class="form-group"><label for="expenseCategory">Category</label><select id="expenseCategory" onchange="handleCategoryChange()" required><option value="">Select Category</option><option value="Collective">Collective (Split among 8)</option><option value="Sub-group">Sub-group (Select people)</option></select></div>
                            <div class="form-group"><label for="expensePaidBy">Paid By</label><select id="expensePaidBy" required><option value="">Select Person</option></select></div>
                        </div>
                        <div class="form-group" id="involvedPartiesGroup" style="display:none;">
                            <label>Involved Parties (for Sub-group)</label>
                            <div class="multi-select-container">
                                <div class="selected-names" id="selectedNamesDisplay">Select Names...</div>
                                <div class="checkbox-options" id="participantCheckboxes"></div>
                            </div>
                        </div>
                        <div class="button-group"><button class="btn" onclick="addExpense()">Add Expense</button><button class="btn btn-danger" onclick="clearExpenseForm()">Clear Form</button></div>
                    </div>

                    <div class="section">
                        <h2>ðŸ’¸ Record Payment / Repayment</h2>
                        <div class="expense-form">
                            <div class="form-group"><label for="paymentDate">Payment Date</label><input type="date" id="paymentDate" required></div>
                            <div class="form-group"><label for="paymentPayer">Who Paid? (Payer)</label><select id="paymentPayer" required></select></div>
                            <div class="form-group"><label for="paymentReceiver">To Whom? (Receiver)</label><select id="paymentReceiver" required></select></div>
                            <div class="form-group"><label for="paymentAmount">Amount (BDT)</label><input type="number" id="paymentAmount" placeholder="0" step="0.01" required></div>
                            <div class="form-group"><label for="paymentDescription">Description (Optional)</label><input type="text" id="paymentDescription" placeholder="e.g., Settling dinner bill"></div>
                        </div>
                        <div class="button-group"><button class="btn btn-success" onclick="addPayment()">Record Payment</button><button class="btn btn-danger" onclick="clearPaymentForm()">Clear Form</button></div>
                        <div id="paymentPreview" class="payment-preview-container"></div>
                    </div>
                </div>

                <div id="expense_log" class="tab-content">
                    <h2>ðŸ§¾ Expense Log</h2>
                    <div class="table-container" style="margin-top: 25px;">
                        <table id="expenseTable">
                            <thead><tr><th></th><th>Date</th><th>Description</th><th>Total</th><th>Paid By</th><th>Status</th><th>Action</th></tr></thead>
                            <tbody id="expenseBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="payment_log" class="tab-content">
                    <h2>ðŸ’¸ Payment Log</h2>
                    <div class="table-container" style="margin-top: 25px;">
                        <table id="paymentTable">
                            <thead><tr><th>Date</th><th>Payer</th><th>Receiver</th><th>Amount</th><th>Balance Changes</th><th>Description</th><th>Action</th></tr></thead>
                            <tbody id="paymentBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="individual_dashboard" class="tab-content">
                    <h2>ðŸ‘¤ Individual Dashboard</h2>
                    <div class="form-group" style="margin-bottom: 25px; max-width: 400px;">
                        <label for="individualSelector">Select a Participant to View Their Detailed Breakdown</label>
                        <select id="individualSelector" onchange="updateAllDisplays()"></select>
                    </div>
                    <div id="individualSummaryContainer" class="summary-grid" style="margin-bottom: 25px;"></div>
                    <div id="individualDetailContainer"></div>
                </div>

                <div id="settlement_matrix" class="tab-content">
                    <h2>ðŸ”„ Settlement Matrix</h2>
                    <p style="margin-bottom:20px; text-align:center;">This grid shows who needs to pay whom based on the simplified settlement calculation. Read as: <strong>Row Payer</strong> owes <strong>Column Receiver</strong>.</p>
                    <div class="table-container" id="paymentMatrixContainer"></div>
                </div>
                
                <div id="insights" class="tab-content">
                    <div class="section">
                        <h2>âœ¨ Trip Summary</h2>
                        <p style="margin-bottom:20px;">Get an AI-generated summary of the trip's spending habits, total costs, and top contributors.</p>
                        <div class="button-group">
                            <button class="btn" id="generateSummaryBtn" onclick="generateTripSummary()">âœ¨ Generate Summary</button>
                        </div>
                        <div id="summaryResultLoader" class="loader" style="display: none;"></div>
                        <div id="summaryResult" class="gemini-result-box" style="display: none;"></div>
                    </div>
                    <div class="section">
                        <h2>âœ¨ Settlement Message</h2>
                        <p style="margin-bottom:20px;">Generate a friendly, copy-pasteable message for your group chat that clearly explains who needs to pay whom.</p>
                        <div class="button-group">
                            <button class="btn btn-success" id="generateSettlementBtn" onclick="generateSettlementMessage()">âœ¨ Generate Message</button>
                        </div>
                         <div id="settlementResultLoader" class="loader" style="display: none;"></div>
                        <div id="settlementResultContainer" style="display: none;">
                            <div id="settlementResult" class="gemini-result-box"></div>
                            <button id="copySettlementBtn" class="copy-btn" title="Copy Message">ðŸ“‹ Copy</button>
                        </div>
                    </div>
                </div>
                
                <div id="data_management" class="tab-content">
                    <div class="section">
                        <h2>ðŸ’¾ Export Data</h2>
                        <p style="margin-bottom:20px;">Save a backup of all expenses and payments for this trip to a local file.</p>
                        <div class="button-group">
                            <button class="btn btn-secondary" onclick="exportData()">ðŸ“¦ Export to File</button>
                        </div>
                    </div>
                    <div class="section">
                        <h2>ðŸ’¾ Import Data</h2>
                        <p style="margin-bottom:20px;">Load data from a previously exported file. This will add the imported data to the current trip for everyone to see.</p>
                        <div class="button-group">
                             <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData()">
                             <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ðŸ“¤ Import from File</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, onSnapshot, collection, query, deleteDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const participants = ['Nafi', 'Himika', 'Mysha', 'Rafid', 'Razon', 'Naima', 'Zohra', 'Fatin'];
        let expenses = [];
        let payments = [];

        // Firestore Globals
        let db, auth;
        let tripId;
        let expensesCollection, paymentsCollection;
        let unsubscribeExpenses, unsubscribePayments;

        // App Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            setupTripId();
            await initializeFirebase();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
            document.getElementById('paymentDate').value = today;
            
            setupAllSelectors();
            initializeTableEditing();
            initializeRowExpansion();
            
            document.getElementById('paymentPayer').addEventListener('change', updatePaymentPreview);
            document.getElementById('paymentReceiver').addEventListener('change', updatePaymentPreview);
            document.getElementById('paymentAmount').addEventListener('input', updatePaymentPreview);
            
            document.getElementById('tripId').addEventListener('click', copyTripId);
            document.getElementById('copySettlementBtn').addEventListener('click', () => {
                const textToCopy = document.getElementById('settlementResult').innerText;
                copyTextToClipboard(textToCopy, 'copySettlementBtn');
            });

            updatePaymentPreview();
            updateAllDisplays();
        });

        function setupTripId() {
            let id = '';
            if (window.location.hash) {
                id = window.location.hash.substring(1).replace(/[^a-zA-Z0-9]/g, '');
            } 
            
            if (!id) { 
                id = Math.random().toString(36).substring(2, 10);
            }

            tripId = id;
            
            if (window.location.hash !== `#${tripId}`) {
                window.location.hash = tripId;
            }

            document.getElementById('tripId').textContent = tripId;
        }

        async function initializeFirebase() {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (typeof __initial_auth_token !== 'undefined') { 
                    await signInWithCustomToken(auth, __initial_auth_token); 
                } else { 
                    await signInAnonymously(auth); 
                }
                
                onAuthStateChanged(auth, user => {
                    if (user) {
                        console.log("User is signed in with uid:", user.uid);
                        const expensesPath = `/artifacts/${appId}/public/data/expenses_${tripId}`;
                        const paymentsPath = `/artifacts/${appId}/public/data/payments_${tripId}`;
                        expensesCollection = collection(db, expensesPath);
                        paymentsCollection = collection(db, paymentsPath);
                        setupRealtimeListeners();
                    } else {
                        console.log("User is signed out.");
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert("Could not connect to the database. Please check your connection and refresh.");
            }
        }

        function setupRealtimeListeners() {
            if (unsubscribeExpenses) unsubscribeExpenses();
            if (unsubscribePayments) unsubscribePayments();

            const expensesQuery = query(expensesCollection);
            unsubscribeExpenses = onSnapshot(expensesQuery, (snapshot) => {
                expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllDisplays();
            }, (error) => console.error("Error fetching expenses:", error));

            const paymentsQuery = query(paymentsCollection);
            unsubscribePayments = onSnapshot(paymentsQuery, (snapshot) => {
                payments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllDisplays();
            }, (error) => console.error("Error fetching payments:", error));
        }
        
        // Make functions global
        window.switchTab = switchTab;
        window.addExpense = addExpense;
        window.clearExpenseForm = clearExpenseForm;
        window.addPayment = addPayment;
        window.clearPaymentForm = clearPaymentForm;
        window.deleteRow = deleteRow;
        window.updateAllDisplays = updateAllDisplays;
        window.handleCategoryChange = handleCategoryChange;
        window.updateSelectedNamesDisplay = updateSelectedNamesDisplay;
        window.generateTripSummary = generateTripSummary;
        window.generateSettlementMessage = generateSettlementMessage;
        window.exportData = exportData;
        window.importData = importData;

        // --- Data Management ---
        function exportData() {
            const dataToExport = {
                expenses: expenses,
                payments: payments,
                exportedAt: new Date().toISOString()
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `trip-data-${tripId}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        async function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            if (!file) {
                alert("Please select a file to import.");
                return;
            }

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    if (!data.expenses || !data.payments) {
                        throw new Error("Invalid data file. Missing 'expenses' or 'payments' array.");
                    }
                    
                    if (!confirm(`This will add ${data.expenses.length} expenses and ${data.payments.length} payments to the current trip. Are you sure you want to continue?`)) {
                        return;
                    }

                    const batch = writeBatch(db);

                    data.expenses.forEach(expense => {
                        const { id, ...expenseData } = expense; // Exclude old ID
                        const docRef = doc(expensesCollection); // Create new doc with new ID
                        batch.set(docRef, expenseData);
                    });

                    data.payments.forEach(payment => {
                        const { id, ...paymentData } = payment; // Exclude old ID
                        const docRef = doc(paymentsCollection); // Create new doc with new ID
                        batch.set(docRef, paymentData);
                    });

                    await batch.commit();
                    alert("Data imported successfully and synced for all users!");

                } catch (error) {
                    console.error("Error importing data:", error);
                    alert(`Failed to import data: ${error.message}`);
                } finally {
                    fileInput.value = ''; // Reset file input
                }
            };
            reader.readAsText(file);
        }

        // --- Gemini API Call Function ---
        async function callGemini(prompt, button) {
            button.disabled = true;
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            let responseText = "Sorry, something went wrong. Please try again.";
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    responseText = candidate.content.parts[0].text;
                } else {
                     responseText = "Received an empty response from the AI. Please try rephrasing.";
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                responseText = `Error: ${error.message}. Check the console for details.`;
            } finally {
                button.disabled = false;
            }
            return responseText;
        }

        async function generateTripSummary() {
            const btn = document.getElementById('generateSummaryBtn');
            const loader = document.getElementById('summaryResultLoader');
            const resultBox = document.getElementById('summaryResult');

            loader.style.display = 'block';
            resultBox.style.display = 'none';
            
            if (expenses.length === 0) {
                resultBox.innerHTML = "There are no expenses to summarize yet!";
                loader.style.display = 'none';
                resultBox.style.display = 'block';
                return;
            }

            const totalSpent = expenses.reduce((sum, e) => sum + e.amount, 0);
            const balances = calculateBalances();
            const topSpender = Object.entries(balances).sort((a, b) => b[1].paid - a[1].paid)[0];
            
            const expenseData = expenses.map(e => `${e.description}: ${e.amount.toFixed(2)} BDT paid by ${e.paidBy}`).join('\n');

            const prompt = `You are a friendly trip accountant. Based on the following expense data for a group trip to Cox's Bazar, provide a short, engaging, and insightful summary.
            
            Important Data:
            - Total amount spent on the trip: ${totalSpent.toFixed(2)} BDT.
            - The person who paid for the most was ${topSpender[0]} with a total of ${topSpender[1].paid.toFixed(2)} BDT.
            - Full expense list:
            ${expenseData}

            Please analyze this data and generate a summary. Mention the total spending, highlight the top spender, and point out one or two interesting spending patterns if you see any (e.g., most money was spent on food, travel, etc.). Keep the tone light and friendly. Start with a fun greeting like "Hey team!".`;

            const summary = await callGemini(prompt, btn);
            resultBox.innerText = summary;
            loader.style.display = 'none';
            resultBox.style.display = 'block';
        }

        async function generateSettlementMessage() {
            const btn = document.getElementById('generateSettlementBtn');
            const loader = document.getElementById('settlementResultLoader');
            const resultContainer = document.getElementById('settlementResultContainer');
            const resultBox = document.getElementById('settlementResult');
            
            loader.style.display = 'block';
            resultContainer.style.display = 'none';

            const balances = calculateBalances();
            const matrix = getSettlementMatrix(balances);
            let settlementSteps = [];
            participants.forEach(payer => {
                participants.forEach(receiver => {
                    if (matrix[payer] && matrix[payer][receiver] > 0.01) {
                        settlementSteps.push(`${payer} should pay ${receiver} ${matrix[payer][receiver].toFixed(2)} BDT.`);
                    }
                });
            });
            
            if (settlementSteps.length === 0) {
                resultBox.innerHTML = "Everyone is already settled up. No payments are needed!";
                loader.style.display = 'none';
                resultContainer.style.display = 'block';
                return;
            }

            const settlementData = settlementSteps.join('\n');
            const prompt = `You are helping a group of friends settle their trip expenses. Based on the following simplified payment list, write a clear, friendly, and concise message that can be posted in a group chat (like WhatsApp or Messenger).

            Payment List:
            ${settlementData}

            The message should be easy to understand. Start with a friendly opening, list the payments clearly (you can use bullet points or numbered lists), and end with a positive closing note. Make it feel helpful and not demanding.`;
            
            const message = await callGemini(prompt, btn);
            resultBox.innerText = message;
            loader.style.display = 'none';
            resultContainer.style.display = 'block';
        }


        function setupAllSelectors() {
            const selectors = [
                document.getElementById('expensePaidBy'),
                document.getElementById('paymentPayer'),
                document.getElementById('paymentReceiver'),
                document.getElementById('individualSelector')
            ];
            const participantCheckboxes = document.getElementById('participantCheckboxes');
            
            let optionsHTML = '<option value="">-- Select Person --</option>';
            let checkboxesHTML = '';

            participants.forEach(p => {
                optionsHTML += `<option value="${p}">${p}</option>`;
                checkboxesHTML += `<label><input type="checkbox" value="${p}" onchange="updateSelectedNamesDisplay()"> ${p}</label>`;
            });

            selectors.forEach(sel => sel.innerHTML = optionsHTML);
            participantCheckboxes.innerHTML = checkboxesHTML;

            document.getElementById('selectedNamesDisplay').addEventListener('click', () => participantCheckboxes.classList.toggle('visible'));
            document.addEventListener('click', e => { 
                if (!e.target.closest('.multi-select-container')) {
                    participantCheckboxes.classList.remove('visible');
                }
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function updateSelectedNamesDisplay() {
            const selected = Array.from(document.querySelectorAll('#participantCheckboxes input:checked')).map(cb => cb.value);
            document.getElementById('selectedNamesDisplay').textContent = selected.length > 0 ? selected.join(', ') : 'Select Names...';
        }

        function handleCategoryChange() {
            document.getElementById('involvedPartiesGroup').style.display = document.getElementById('expenseCategory').value === 'Sub-group' ? 'block' : 'none';
        }

        async function addExpense() {
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value;
            const paidBy = document.getElementById('expensePaidBy').value;
            if (!amount || !category || !paidBy) { alert('Amount, Category, and Paid By are required.'); return; }

            const involvedPeople = category === 'Collective' ? participants : 
                Array.from(document.querySelectorAll('#participantCheckboxes input:checked')).map(cb => cb.value);
            if (category === 'Sub-group' && involvedPeople.length === 0) { alert('Please select involved people for the sub-group.'); return; }

            const newExpenseData = {
                date: document.getElementById('expenseDate').value,
                description: document.getElementById('expenseDescription').value || 'N/A',
                amount, category, paidBy, shares: {}
            };

            participants.forEach(p => newExpenseData.shares[p] = 0);
            if (involvedPeople.length > 0) {
                const share = amount / involvedPeople.length;
                involvedPeople.forEach(p => newExpenseData.shares[p] = share);
            }
            
            try {
                await addDoc(expensesCollection, newExpenseData);
                clearExpenseForm();
            } catch (error) {
                console.error("Error adding expense: ", error);
                alert("Failed to add expense. Please try again.");
            }
        }
        
        async function addPayment() {
            const payer = document.getElementById('paymentPayer').value;
            const receiver = document.getElementById('paymentReceiver').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            
            if (!payer || !receiver || !amount) { alert('Payer, Receiver, and Amount are required.'); return; }
            if (payer === receiver) { alert('Payer and Receiver cannot be the same.'); return; }

            const newPaymentData = {
                date: document.getElementById('paymentDate').value,
                payer, receiver, amount, 
                description: document.getElementById('paymentDescription').value || 'N/A'
            };

            try {
                await addDoc(paymentsCollection, newPaymentData);
                clearPaymentForm();
            } catch (error) {
                console.error("Error adding payment: ", error);
                alert("Failed to add payment. Please try again.");
            }
        }

        function clearExpenseForm() {
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseCategory').value = '';
            document.getElementById('expensePaidBy').value = '';
            document.querySelectorAll('#participantCheckboxes input:checked').forEach(cb => cb.checked = false);
            updateSelectedNamesDisplay(); handleCategoryChange();
        }

        function clearPaymentForm() {
            document.getElementById('paymentPayer').value = '';
            document.getElementById('paymentReceiver').value = '';
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentDescription').value = '';
            updatePaymentPreview();
        }

        async function deleteRow(type, id) {
            if (confirm(`Are you sure you want to delete this ${type}? This action will be synced for all users.`)) {
                try {
                    if (type === 'expense') {
                        await deleteDoc(doc(db, expensesCollection.path, id));
                    }
                    if (type === 'payment') {
                        await deleteDoc(doc(db, paymentsCollection.path, id));
                    }
                } catch (error) {
                    console.error(`Error deleting ${type}:`, error);
                    alert(`Failed to delete ${type}. Please try again.`);
                }
            }
        }
        
        function initializeRowExpansion() {
            document.getElementById('expenseBody').addEventListener('click', (event) => {
                const mainRow = event.target.closest('.main-row');
                if (!mainRow || event.target.closest('.delete-btn')) return; 
                const expenseId = mainRow.dataset.id;
                const detailsRowId = `details-${expenseId}`;
                const existingDetailsRow = document.getElementById(detailsRowId);
                if (existingDetailsRow) {
                    existingDetailsRow.remove();
                    mainRow.classList.remove('expanded');
                } else {
                    mainRow.classList.add('expanded');
                    const expense = expenses.find(e => e.id === expenseId);
                    const detailsRow = document.createElement('tr');
                    detailsRow.className = 'details-row';
                    detailsRow.id = detailsRowId;
                    let detailsContent = '<div class="details-content">';
                    participants.forEach(p => {
                        detailsContent += `<div class="share-item"><label>${p}</label><div class="share-cell" contenteditable="true" data-id="${expenseId}" data-person="${p}">${(expense.shares[p] || 0).toFixed(2)}</div></div>`;
                    });
                    detailsContent += '</div>';
                    detailsRow.innerHTML = `<td colspan="7">${detailsContent}</td>`;
                    mainRow.insertAdjacentElement('afterend', detailsRow);
                }
            });
        }

        function initializeTableEditing() {
            document.getElementById('expenseBody').addEventListener('blur', async (event) => {
                const target = event.target; 
                if (!target.isContentEditable) return;
                
                const id = target.dataset.id || target.closest('.main-row')?.dataset.id || target.closest('.details-row')?.dataset.id;
                const field = target.dataset.field; 
                const person = target.dataset.person;
                let value = target.textContent.trim();
                const expense = expenses.find(e => e.id === id); 
                if (!expense) return;

                const docRef = doc(db, expensesCollection.path, id);
                let updates = {};

                try {
                    if (person) {
                        const shareValue = parseFloat(value);
                        if (isNaN(shareValue)) { target.textContent = expense.shares[person].toFixed(2); return; }
                        updates[`shares.${person}`] = shareValue;
                        updates['category'] = 'Custom'; 
                    } else {
                        if (field === 'amount') {
                            const amountValue = parseFloat(value);
                            if (isNaN(amountValue)) { target.textContent = expense.amount.toFixed(2); return; }
                            updates[field] = amountValue;
                        } else { 
                            updates[field] = value; 
                        }
                    }
                    await updateDoc(docRef, updates);
                } catch (error) {
                    console.error("Error updating document:", error);
                    alert("Failed to save changes. Please try again.");
                    updateAllDisplays();
                }
            }, true);
        }

        function updateAllDisplays() {
            if (!expenses || !payments) return;
            const balances = calculateBalances();
            updateExpenseLedger();
            updatePaymentLedger(balances);
            updateIndividualDashboard(balances);
            updatePaymentMatrix(balances);
        }

        function calculateBalances() {
            const balances = {};
            participants.forEach(p => {
                const totalPaid = expenses.filter(e => e.paidBy === p).reduce((s, e) => s + e.amount, 0);
                const totalOwed = expenses.reduce((s, e) => s + (e.shares[p] || 0), 0);
                const paymentsMade = payments.filter(pm => pm.payer === p).reduce((s, pm) => s + pm.amount, 0);
                const paymentsReceived = payments.filter(pr => pr.receiver === p).reduce((s, pr) => s + pr.amount, 0);
                
                balances[p] = {
                    paid: totalPaid, owed: totalOwed,
                    originalBalance: totalPaid - totalOwed,
                    finalBalance: (totalPaid - totalOwed) - paymentsReceived + paymentsMade
                };
            });
            return balances;
        }

        function updateExpenseLedger() {
            const tbody = document.getElementById('expenseBody');
            tbody.innerHTML = '';
            expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(e => {
                const sharesSum = Object.values(e.shares).reduce((sum, val) => sum + val, 0);
                const discrepancy = Math.abs(e.amount - sharesSum) > 0.01;
                const rowClass = discrepancy ? 'discrepancy-row' : '';
                const status = discrepancy ? `<span class="status-warning">Warning</span>` : `<span class="status-ok">OK</span>`;
                tbody.innerHTML += `<tr class="main-row ${rowClass}" data-id="${e.id}"><td><span class="expand-icon">â–¶</span>${e.date}</td><td data-field="description" contenteditable="true">${e.description}</td><td data-field="amount" contenteditable="true">${e.amount.toFixed(2)}</td><td data-field="paidBy" contenteditable="true">${e.paidBy}</td><td>${status}</td><td><button class="delete-btn" onclick="deleteRow('expense', '${e.id}')">Delete</button></td></tr>`;
            });
        }

        function updatePaymentLedger(balances) {
            const tbody = document.getElementById('paymentBody');
            tbody.innerHTML = '';
            payments.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(p => {
                const payerBalanceAfter = balances[p.payer].finalBalance;
                const receiverBalanceAfter = balances[p.receiver].finalBalance;
                
                const payerBalanceBefore = payerBalanceAfter - p.amount;
                const receiverBalanceBefore = receiverBalanceAfter + p.amount;

                const formatChange = (name, before, after) => {
                    const beforeClass = before >= 0 ? 'balance-positive' : 'balance-negative';
                    const afterClass = after >= 0 ? 'balance-positive' : 'balance-negative';
                    return `<strong>${name}:</strong> <span class="${beforeClass}">${before.toFixed(2)}</span> â†’ <span class="${afterClass}">${after.toFixed(2)}</span>`;
                };
                const balanceChangeHTML = `<div style="line-height: 1.5;"><div>${formatChange(p.payer, payerBalanceBefore, payerBalanceAfter)}</div><div>${formatChange(p.receiver, receiverBalanceBefore, receiverBalanceAfter)}</div></div>`;
                tbody.innerHTML += `<tr data-id="${p.id}"><td>${p.date}</td><td>${p.payer}</td><td>${p.receiver}</td><td>${p.amount.toFixed(2)}</td><td>${balanceChangeHTML}</td><td>${p.description}</td><td><button class="delete-btn" onclick="deleteRow('payment', '${p.id}')">Delete</button></td></tr>`;
            });
        }

        function updatePaymentPreview() {
            const payer = document.getElementById('paymentPayer').value;
            const receiver = document.getElementById('paymentReceiver').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value) || 0;
            const previewDiv = document.getElementById('paymentPreview');

            if (!payer || !receiver || amount <= 0) {
                previewDiv.innerHTML = 'Enter payer, receiver, and amount to see a live preview.';
                return;
            }
            if (payer === receiver) {
                previewDiv.innerHTML = '<span style="color: #dc3545; font-weight: bold;">Payer and Receiver cannot be the same.</span>';
                return;
            }

            const currentBalances = calculateBalances();
            const payerBalance = currentBalances[payer].finalBalance;
            const receiverBalance = currentBalances[receiver].finalBalance;
            
            const newPayerBalance = payerBalance + amount;
            const newReceiverBalance = receiverBalance - amount;
            const formatBal = bal => `à§³${bal.toFixed(2)}`;

            previewDiv.innerHTML = `<strong>Preview of Balance After Repayment:</strong><br>
                <strong>${payer}</strong> (Payer): ${formatBal(payerBalance)} â†’ <strong class="${newPayerBalance >= 0 ? 'balance-positive' : 'balance-negative'}">${formatBal(newPayerBalance)}</strong><br>
                <strong>${receiver}</strong> (Receiver): ${formatBal(receiverBalance)} â†’ <strong class="${newReceiverBalance >= 0 ? 'balance-positive' : 'balance-negative'}">${formatBal(newReceiverBalance)}</strong>`;
        }
        
        function updateIndividualDashboard(balances) {
            const selectedPerson = document.getElementById('individualSelector').value;
            const summaryContainer = document.getElementById('individualSummaryContainer');
            const detailContainer = document.getElementById('individualDetailContainer');

            if (!selectedPerson) {
                summaryContainer.innerHTML = '';
                detailContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Please select a person from the dropdown to see their details.</p>';
                return;
            }

            const personBalance = balances[selectedPerson];
            summaryContainer.innerHTML = `<div class="summary-card"><h3>Total Paid</h3><div class="summary-value balance-positive">à§³${personBalance.paid.toFixed(2)}</div></div><div class="summary-card"><h3>Total Share</h3><div class="summary-value balance-negative">à§³${personBalance.owed.toFixed(2)}</div></div><div class="summary-card"><h3>Final Balance</h3><div class="summary-value ${personBalance.finalBalance >= 0 ? 'balance-positive' : 'balance-negative'}">à§³${personBalance.finalBalance.toFixed(2)}</div><div class="action-required ${personBalance.finalBalance > 0.01 ? 'should-receive' : (personBalance.finalBalance < -0.01 ? 'awaiting-payment' : 'settled')}">${personBalance.finalBalance > 0.01 ? 'Should Receive' : (personBalance.finalBalance < -0.01 ? 'Should Pay' : 'Settled')}</div></div>`;

            let detailHTML = '<h3>Expense Breakdown</h3>';
            const relevantExpenses = expenses.filter(e => e.paidBy === selectedPerson || (e.shares[selectedPerson] || 0) > 0);
            
            if (relevantExpenses.length === 0) {
                detailHTML += '<p style="text-align:center; padding: 20px;">No expenses involving this person.</p>';
            } else {
                detailHTML += `<div class="table-container"><table><thead><tr><th>Date</th><th>Description</th><th>Paid By</th><th>Your Share (Owed)</th><th>You Paid</th><th>Net for Expense</th></tr></thead><tbody>`;
                relevantExpenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(e => {
                    const yourShare = e.shares[selectedPerson] || 0;
                    const youPaid = e.paidBy === selectedPerson ? e.amount : 0;
                    const net = youPaid - yourShare;
                    const netClass = net >= 0 ? 'balance-positive' : 'balance-negative';
                    detailHTML += `<tr><td>${e.date}</td><td>${e.description}</td><td>${e.paidBy}</td><td class="balance-negative">à§³${yourShare.toFixed(2)}</td><td class="balance-positive">à§³${youPaid.toFixed(2)}</td><td class="${netClass}">${net >= 0 ? '+' : ''}à§³${net.toFixed(2)}</td></tr>`;
                });
                detailHTML += '</tbody></table></div>';
            }

            const paymentsMade = payments.filter(p => p.payer === selectedPerson);
            const paymentsReceived = payments.filter(p => p.receiver === selectedPerson);

            if (paymentsMade.length > 0 || paymentsReceived.length > 0) {
                detailHTML += '<h3 style="margin-top: 25px;">Repayments Breakdown</h3>';
                detailHTML += `<div class="table-container"><table><thead><tr><th>Date</th><th>Transaction</th><th>Amount</th></tr></thead><tbody>`;
                paymentsMade.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(p => { detailHTML += `<tr><td>${p.date}</td><td>You paid ${p.receiver}</td><td class="balance-negative">- à§³${p.amount.toFixed(2)}</td></tr>`; });
                paymentsReceived.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(p => { detailHTML += `<tr><td>${p.date}</td><td>You received from ${p.payer}</td><td class="balance-positive">+ à§³${p.amount.toFixed(2)}</td></tr>`; });
                detailHTML += '</tbody></table></div>';
            }
            detailContainer.innerHTML = detailHTML;
        }

        function getSettlementMatrix(balances) {
             const matrix = {};
            participants.forEach(p1 => { matrix[p1] = {}; participants.forEach(p2 => { matrix[p1][p2] = 0; }); });
            const debtors = [], creditors = [];
            Object.entries(balances).forEach(([p, b]) => {
                if (b.finalBalance < -0.01) debtors.push({ name: p, amount: Math.abs(b.finalBalance) });
                else if (b.finalBalance > 0.01) creditors.push({ name: p, amount: b.finalBalance });
            });
            debtors.sort((a, b) => b.amount - a.amount); creditors.sort((a, b) => b.amount - a.amount);
            while (debtors.length > 0 && creditors.length > 0) {
                const debtor = debtors[0], creditor = creditors[0];
                const amount = Math.min(debtor.amount, creditor.amount);
                if (amount > 0.01) matrix[debtor.name][creditor.name] = amount;
                debtor.amount -= amount; creditor.amount -= amount;
                if (debtor.amount < 0.01) debtors.shift();
                if (creditor.amount < 0.01) creditors.shift();
            }
            return matrix;
        }

        function updatePaymentMatrix(balances) {
            const container = document.getElementById('paymentMatrixContainer');
            const matrix = getSettlementMatrix(balances);
            
            let tableHTML = '<table class="matrix-table"><thead><tr><th>Payer â†“ | Receiver â†’</th>';
            participants.forEach(p => { tableHTML += `<th>${p}</th>`; });
            tableHTML += '</tr></thead><tbody>';
            participants.forEach(payer => {
                tableHTML += `<tr><td class="header-cell">${payer}</td>`;
                participants.forEach(receiver => {
                    if (payer === receiver) { tableHTML += '<td class="diagonal-cell">--</td>'; }
                    else {
                        const amount = matrix[payer][receiver];
                        if (amount > 0.01) {
                            const tooltip = `${payer} owes ${receiver} à§³${amount.toFixed(2)}`;
                            tableHTML += `<td class="payment-due-cell" data-tooltip="${tooltip}">à§³${amount.toFixed(2)}</td>`;
                        } else { tableHTML += '<td class="no-payment-cell">--</td>'; }
                    }
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }
        
        function copyTripId() {
            copyTextToClipboard(window.location.href, 'copyFeedback');
        }
        
        function copyTextToClipboard(text, feedbackElementId) {
            const textArea = document.createElement("textarea");
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            textArea.style.padding = 0;
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            textArea.style.background = 'transparent';
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const feedback = document.getElementById(feedbackElementId);
                    if (feedback) {
                       const originalText = feedback.innerText;
                       feedback.innerText = 'Copied!';
                       feedback.style.display = 'inline';
                       setTimeout(() => { 
                           feedback.style.display = 'none';
                           feedback.innerText = originalText;
                        }, 2000);
                    } else { // Handle copy button for settlement text
                        const btn = document.getElementById('copySettlementBtn');
                        const originalBtnText = btn.innerText;
                        btn.innerText = 'Copied!';
                        setTimeout(() => { btn.innerText = originalBtnText; }, 2000);
                    }
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }

            document.body.removeChild(textArea);
        }

    </script>
</body>
</html>

